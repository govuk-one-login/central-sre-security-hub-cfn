
AWSTemplateFormatVersion: "2010-09-09"
Description: CloudFormation template for creating github deployment role.

Resources:

  GitHubActionsRole:
    Type: AWS::IAM::Role
    Properties:
      Description: IAM role to be assumed by GitHub for deployments.
      RoleName: github-deployment-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action: "sts:AssumeRoleWithWebIdentity"
            Principal:
              Federated: !ImportValue GitHubIdentityProviderArn
            Condition:
              StringLike:
                token.actions.githubusercontent.com:sub: repo:govuk-one-login/central-sre-security-hub-cfn:*

  GitHubActionsRoleIamPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: github-deployment-role-policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "cloudformation:ValidateTemplate"
            Resource: "*"
          - Effect: Allow
            Action:
              - "s3:PutObject"
              - "s3:GetObject"
              - "s3:ListBucket"
              - "s3:DeleteObject"
            Resource: 
              - "arn:aws:s3:::di-central-sre-build-taskcat/*"
              - "arn:aws:s3:::di-central-sre-build-taskcat"
          - Effect: Allow
            Action:
              - "cloudformation:CreateStack"
              - "cloudformation:DescribeStacks"
              - "cloudformation:DescribeStackEvents"
              - "cloudformation:ListStacks"
              - "cloudformation:UpdateStack"
              - "cloudformation:ValidateTemplate"
              - "lambda:AddPermission"
              - "s3:GetBucketLocation"
              - "s3:ListAllMyBuckets"
              - "secretsmanager:CreateSecret"
              - "secretsmanager:DescribeSecret"
              - "secretsmanager:RotateSecret"
              - "secretsmanager:TagResource"
            Resource: "*"
          - Effect: Allow
            Action:
              - "kms:*"
            # TODO the key should be created in this template
            Resource: "arn:aws:kms:eu-west-2:891376909120:key/88564c70-2d7f-4781-b6a2-c1e10f62692c"
          - Effect: Allow
            Action:
              - "lambda:*"
            # TODO Creation of this lambda needs to be in IaC
            Resource: "arn:aws:lambda:eu-west-2:891376909120:function:fakeSecretRotate"
      Roles: 
        - !Ref GitHubActionsRole
      
    