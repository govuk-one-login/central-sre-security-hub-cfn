
AWSTemplateFormatVersion: "2010-09-09"
Description: CloudFormation template for creating github deployment role.

Resources:

  GitHubActionsRole:
    Type: AWS::IAM::Role
    Properties:
      Description: IAM role to be assumed by GitHub for deployments.
      RoleName: github-deployment-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action: "sts:AssumeRoleWithWebIdentity"
            Principal:
              Federated: !ImportValue GitHubIdentityProviderArn
            Condition:
              StringLike:
                token.actions.githubusercontent.com:sub: repo:govuk-one-login/central-sre-security-hub-cfn:*

  GitHubActionsRoleIamPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: github-deployment-role-policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "cloudformation:ValidateTemplate"
            Resource: "*"
          - Effect: Allow
            Action:
              - "s3:PutObject"
              - "s3:GetObject"
              - "s3:ListBucket"
              - "s3:DeleteObject"
            Resource: 
              - "arn:aws:s3:::di-central-sre-build-taskcat/*"
              - "arn:aws:s3:::di-central-sre-build-taskcat"
              - "arn:aws:s3:::di-central-sre-build-artifacts"
              - "arn:aws:s3:::di-central-sre-build-artifacts/*"
          - Effect: Allow
            Action:
              - "cloudformation:CreateStack"
              - "cloudformation:DeleteStack"
              - "cloudformation:DescribeStacks"
              - "cloudformation:DescribeStackEvents"
              - "cloudformation:ListStacks"
              - "cloudformation:ListStackResources"
              - "cloudformation:UpdateStack"
              - "cloudformation:ValidateTemplate"
              - "lambda:AddPermission"
              - "s3:GetBucketLocation"
              - "s3:ListAllMyBuckets"
              - "secretsmanager:CancelRotateSecret"
              - "secretsmanager:CreateSecret"
              - "secretsmanager:DeleteSecret"
              - "secretsmanager:DescribeSecret"
              - "secretsmanager:RotateSecret"
              - "secretsmanager:TagResource"
              - "securityhub:GetFindings"
            Resource: "*"
          - Effect: Allow
            Action:
              - "kms:*"
            Resource: "arn:aws:kms:eu-west-2:891376909120:key/bdfc7df5-95ae-426b-b520-80c3d434ae52"
          - Effect: Allow
            Action:
              - "lambda:*"
            Resource: "arn:aws:lambda:eu-west-2:891376909120:function:sc-product-test-empty-lambda-LambdaFunction-AZvc5k0e2IhP"
      Roles: 
        - !Ref GitHubActionsRole
      
    