
AWSTemplateFormatVersion: "2010-09-09"
Description: CloudFormation template for creating github deployment role.

Resources:

  GitHubActionsRole:
    Type: AWS::IAM::Role
    Properties:
      Description: IAM role to be assumed by GitHub for deployments.
      RoleName: github-deployment-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action: "sts:AssumeRoleWithWebIdentity"
            Principal:
              Federated: !ImportValue GitHubIdentityProviderArn
            Condition:
              StringLike:
                token.actions.githubusercontent.com:sub: repo:govuk-one-login/central-sre-security-hub-cfn:*

  GitHubActionsRoleIamPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: github-deployment-role-policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "cloudformation:ValidateTemplate"
            Resource: "*"
          - Effect: Allow
            Action:
              - "s3:PutObject"
              - "s3:GetObject"
              - "s3:ListBucket"
              - "s3:DeleteObject"
            Resource: 
              - "arn:aws:s3:::di-central-sre-build-taskcat/*"
              - "arn:aws:s3:::di-central-sre-build-taskcat"
              - "arn:aws:s3:::di-central-sre-build-artifact"
              - "arn:aws:s3:::di-central-sre-build-artifact/*"
          - Effect: Allow
            Action:
              - "cloudformation:CreateStack"
              - "cloudformation:DeleteStack"
              - "cloudformation:DescribeStacks"
              - "cloudformation:DescribeStackEvents"
              - "cloudformation:ListStacks"
              - "cloudformation:ListStackResources"
              - "cloudformation:UpdateStack"
              - "cloudformation:ValidateTemplate"
              - "dynamodb:DescribeTable"
              - "dynamodb:CreateTable"
              - "dynamodb:DeleteTable"
              - "dynamodb:DescribeContinuousBackups"
              - "dynamodb:DescribeTimeToLive"
              - "dynamodb:ListTagsOfResource"
              - "dynamodb:UpdateContinuousBackups"
              - "dynamodb:UpdateTimeToLive"
              - "dynamodb:TagResource"
              - "dynamodb:UntagResource"
              - "kms:Create*"
              - "kms:Describe*"
              - "kms:Enable*"
              - "kms:List*"
              - "kms:Put*"
              - "kms:Update*"
              - "kms:Revoke*"
              - "kms:Disable*"
              - "kms:Get*"
              - "kms:Delete*"
              - "kms:ScheduleKeyDeletion"
              - "kms:CancelKeyDeletion"
              - "kms:TagResource"
              - "lambda:AddPermission"
              - "s3:*"
              - "secretsmanager:CancelRotateSecret"
              - "secretsmanager:CreateSecret"
              - "secretsmanager:DeleteSecret"
              - "secretsmanager:DescribeSecret"
              - "secretsmanager:RotateSecret"
              - "secretsmanager:TagResource"
              - "securityhub:GetFindings"
            Resource: "*"
          - Effect: Allow
            Action:
              - "kms:*"
            Resource: "arn:aws:kms:eu-west-2:891376909120:key/31dc9883-64a5-43f9-86b4-ef0f929e3343"
          - Effect: Allow
            Action:
              - "lambda:*"
            Resource: "arn:aws:lambda:eu-west-2:891376909120:function:sc-product-test-empty-lambda-LambdaFunction-NX8tjZ3sq0PX"
      Roles: 
        - !Ref GitHubActionsRole
      
    